<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wanglei.mapper.GoodsMapper">
    <select id="getGoodsAll" resultType="Goods" >
	    SELECT *
	    FROM warehouse_view
	    ORDER BY id
	    LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getGoodsCount" resultType="Integer" >
		SELECT COUNT(*)
		FROM warehouse_view
	</select>

	<select id="getAccountAll" resultType="Goods" >
	    SELECT *
	    FROM account INNER JOIN warehouse_view
	    WHERE account.goods_id = warehouse_view.id
		<if test='goodsId != 0'>
			AND warehouse_view.id = #{goodsId}
		</if>
		<if test='keywords != null'>
			AND
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				username LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				goods_id LIKE concat('%',#{item},'%')
			</foreach>
		</if>
	    ORDER BY update_date DESC
	    LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCount" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id
		<if test='goodsId != 0'>
			AND warehouse_view.id = #{goodsId}
		</if>
		<if test='keywords != null'>
			AND
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				username LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				goods_id LIKE concat('%',#{item},'%')
			</foreach>
		</if>
	</select>

    <select id="getStoreAll" resultType="Goods" >
	    SELECT *
	    FROM account INNER JOIN warehouse_view
	    WHERE account.goods_id = warehouse_view.id AND account.behavior = 0
		<if test='goodsId != 0'>
			AND warehouse_view.id = #{goodsId}
		</if>
	    ORDER BY update_date DESC
	    LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getStoreCount" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND account.behavior = 0
		<if test='goodsId != 0'>
			AND warehouse_view.id = #{goodsId}
		</if>
	</select>

    <select id="getDeliverAll" resultType="Goods" >
	    SELECT *
	    FROM account INNER JOIN warehouse_view
	    WHERE account.goods_id = warehouse_view.id AND account.behavior = 1
		<if test='goodsId != 0'>
			AND warehouse_view.id = #{goodsId}
		</if>
	    ORDER BY update_date DESC
	    LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getDeliverCount" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND account.behavior = 1
		<if test='goodsId != 0'>
			AND warehouse_view.id = #{goodsId}
		</if>
	</select>

	<select id="getGoodsByKeywords" resultType="Goods" >
		SELECT *
	    FROM warehouse_view
		<if test='keywords != null'>
			WHERE
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				id LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				material_name LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				area_name LIKE concat('%',#{item},'%')
			</foreach>
		</if>
		ORDER BY id
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getGoodsCountByKeywords" resultType="Integer" >
		SELECT COUNT(*)
		FROM warehouse_view
		<if test='keywords != null'>
			WHERE
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				id LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				material_name LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				area_name LIKE concat('%',#{item},'%')
			</foreach>
		</if>
	</select>

	<select id="getAccountByKeywords" resultType="Goods" >
		SELECT *
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id

		ORDER BY update_date DESC
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCountByKeywords" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id
		<if test='keywords != null'>
			AND
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				username LIKE concat('%',#{item},'%')
			</foreach>
			OR
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				goods_id LIKE concat('%',#{item},'%')
			</foreach>
		</if>
	</select>

    <select id="getGoodsByMaterial" resultType="Goods" >
	    SELECT *
	    FROM warehouse_view
		<if test='keywords != null'>
			WHERE
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				material_name LIKE concat('%',#{item},'%')
			</foreach>
		</if>
		ORDER BY id
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getGoodsCountByMaterial" resultType="Integer" >
		SELECT COUNT(*)
		FROM warehouse_view
		<if test='keywords != null'>
			WHERE
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				material_name LIKE concat('%',#{item},'%')
			</foreach>
		</if>
	</select>

    <select id="getGoodsByArea" resultType="Goods" >
	    SELECT *
	    FROM warehouse_view
		<if test='keywords != null'>
			WHERE
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				area_name LIKE concat('%',#{item},'%')
			</foreach>
		</if>
		ORDER BY id
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getGoodsCountByArea" resultType="Integer" >
		SELECT COUNT(*)
		FROM warehouse_view
		<if test='keywords != null'>
			WHERE
			<foreach collection='keywords' item='item' index='index' separator=' OR '>
				area_name LIKE concat('%',#{item},'%')
			</foreach>
		</if>
	</select>

	<select id="isExist" resultType="Integer">
		SELECT COUNT(*) AS result
		FROM warehouse_view
		WHERE material_id = #{material_id} AND area_id = #{area_id};
	</select>

	<select id="getId" resultType="Integer">
		SELECT id AS result
		FROM warehouse_view
		WHERE material_id = #{material_id} AND area_id = #{area_id};
	</select>

	<insert id="insertGoods">
        insert into warehouse (material_id, material_size, area_id) values (#{material_id}, #{update_size},#{area_id});
    </insert>

	<delete id="deleteGoods" parameterType="Integer">
        delete from warehouse where id = #{goodsId};
    </delete>

	<insert id="insertAccount">
       insert into account (goods_id, update_date, deliver_owner, update_size, behavior, username) values (#{goodsId}, #{update_date}, #{deliver_owner}, #{update_size}, #{behavior}, #{username});
    </insert>

	<update id="updateAccount">
		<if test='behavior == 0'>
			UPDATE warehouse SET material_size = material_size + #{update_size} WHERE id = #{goodsId};
		</if>
		<if test="behavior == 1">
			UPDATE warehouse SET material_size = material_size - #{update_size} WHERE id = #{goodsId};
		</if>
    </update>

	<select id="getAccountToday" resultType="Goods">
		SELECT * FROM account INNER JOIN warehouse_view
	    WHERE account.goods_id = warehouse_view.id AND to_days(update_date) = to_days(now())
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
		ORDER BY update_date DESC
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCountToday" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND to_days(update_date) = to_days(now())
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
	</select>

	<select id="getAccountYesterday" resultType="Goods">
		SELECT * FROM account INNER JOIN warehouse_view
	    WHERE account.goods_id = warehouse_view.id AND TO_DAYS( NOW( ) ) - TO_DAYS(update_date) = 1
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
		ORDER BY update_date DESC
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCountYesterday" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND TO_DAYS( NOW( ) ) - TO_DAYS(update_date) = 1
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
	</select>

	<select id="getAccountThisWeek" resultType="Goods">
		SELECT * FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(update_date)
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
		ORDER BY update_date DESC
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCountThisWeek" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(update_date)
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
	</select>

	<select id="getAccountByMonth" resultType="Goods">
		SELECT * FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND PERIOD_DIFF( date_format( now( ) , '%Y%m' ) , date_format( update_date, '%Y%m' ) ) =#{month}
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
		ORDER BY update_date DESC
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCountByMonth" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND PERIOD_DIFF( date_format( now( ) , '%Y%m' ) , date_format( update_date, '%Y%m' ) ) =#{month}
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
	</select>

	<select id="getAccountBySeason" resultType="Goods">
		SELECT * FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND QUARTER(update_date)=QUARTER(DATE_SUB(now(),interval #{season} QUARTER))
		AND YEAR(update_date)=YEAR(date_sub(now(),interval #{year} year))
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
		ORDER BY update_date DESC
		LIMIT ${(page-1)*10}, 10;
	</select>

	<select id="getAccountCountBySeason" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND QUARTER(update_date)=QUARTER(DATE_SUB(now(),interval #{season} QUARTER))
		AND YEAR(update_date)=YEAR(date_sub(now(),interval #{year} year))
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
	</select>

	<select id="getAccountByYear" resultType="Goods">
		SELECT * FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND YEAR(update_date)=YEAR(date_sub(now(),interval #{year} year))
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
		ORDER BY update_date DESC
		<if test='page != 0'>
			LIMIT ${(page-1)*10}, 10;
		</if>
	</select>

	<select id="getAccountCountByYear" resultType="Integer" >
		SELECT COUNT(*)
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND YEAR(update_date)=YEAR(date_sub(now(),interval #{year} year))
		<if test='goodsId != 0'>
			AND account.goods_id = #{goodsId}
		</if>
	</select>

	<select id="getStoreSumByArea" resultType="GoodsSum" >
		SELECT SUM( material_size ) as goods_sum, area_name as key_name
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND account.behavior = 0
		GROUP BY area_id;
	</select>

	<select id="getStoreSumByMaterial" resultType="GoodsSum" >
		SELECT SUM( material_size ) as goods_sum, material_name as key_name
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND account.behavior = 0
		GROUP BY material_id;
	</select>

	<select id="getDeliverSumByArea" resultType="GoodsSum" >
		SELECT SUM( update_size ) as goods_sum, area_name as key_name
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND account.behavior = 1
		GROUP BY area_id;
	</select>

	<select id="getDeliverSumByMaterial" resultType="GoodsSum" >
		SELECT SUM( update_size ) as goods_sum, material_name as key_name
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND account.behavior = 1
		GROUP BY material_id;
	</select>

	<select id="getCurrentSumByMaterial" resultType="GoodsSum" >
		SELECT SUM( material_size ) as goods_sum, material_name as key_name
	    FROM warehouse_view
	    GROUP BY material_id;
	</select>

	<select id="getCurrentSumByArea" resultType="GoodsSum" >
		SELECT SUM( material_size ) as goods_sum, area_name as key_name
		FROM warehouse_view
		GROUP BY area_id;
	</select>

	<select id="getSellSumByArea" resultType="GoodsSum" >
		SELECT SUM( update_size ) as goods_sum, behavior as key_name
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND area_id= #{areaId}
		GROUP BY account.behavior;
	</select>

	<select id="getSellSumByMaterial" resultType="GoodsSum" >
		SELECT SUM( update_size ) as goods_sum, behavior as key_name
		FROM account INNER JOIN warehouse_view
		WHERE account.goods_id = warehouse_view.id AND material_id= #{materialId}
		GROUP BY account.behavior;
	</select>

</mapper>